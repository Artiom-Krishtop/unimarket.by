this.BX=this.BX||{};this.BX.Landing=this.BX.Landing||{};this.BX.Landing.UI=this.BX.Landing.UI||{};(function(e,i,t,n,a,s,l,o,r){"use strict";var d=function(e){babelHelpers.inherits(d,e);function d(e){var t;babelHelpers.classCallCheck(this,d);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(d).call(this,e));t.dimensions=babelHelpers.typeof(e.dimensions)==="object"?e.dimensions:null;t.create2xByDefault=e.create2xByDefault!==false;t.uploadParams=babelHelpers.typeof(e.uploadParams)==="object"?e.uploadParams:{};t.onValueChangeHandler=e.onValueChange?e.onValueChange:function(){};t.type=t.content.type||"image";t.allowClear=e.allowClear;t.input.innerText=t.content.src;t.input.hidden=true;t.input2x=t.createInput();t.input2x.innerText=t.content.src2x;t.input2x.hidden=true;t.layout.classList.add("landing-ui-field-image");if(e.compactMode===true){t.layout.classList.add("landing-ui-field-image--compact")}t.disableAltField=typeof e.disableAltField==="boolean"?e.disableAltField:false;t.fileInput=d.createFileInput(t.selector);t.fileInput.addEventListener("change",t.onFileInputChange.bind(babelHelpers.assertThisInitialized(t)));t.linkInput=d.createLinkInput();t.linkInput.onInputHandler=t.onLinkInput.bind(babelHelpers.assertThisInitialized(t));t.dropzone=d.createDropzone(t.selector);t.dropzone.hidden=true;t.dropzone.insertBefore(t.fileInput,t.dropzone.firstElementChild);t.onDragOver=t.onDragOver.bind(babelHelpers.assertThisInitialized(t));t.onDragLeave=t.onDragLeave.bind(babelHelpers.assertThisInitialized(t));t.onDrop=t.onDrop.bind(babelHelpers.assertThisInitialized(t));t.dropzone.addEventListener("dragover",t.onDragOver);t.dropzone.addEventListener("dragleave",t.onDragLeave);t.dropzone.addEventListener("drop",t.onDrop);t.clearButton=d.createClearButton();t.clearButton.on("click",t.onClearClick.bind(babelHelpers.assertThisInitialized(t)));t.preview=d.createImagePreview();t.preview.appendChild(t.clearButton.layout);t.preview.style.backgroundImage="url("+t.input.innerText.trim()+")";t.onImageDragEnter=t.onImageDragEnter.bind(babelHelpers.assertThisInitialized(t));t.preview.addEventListener("dragenter",t.onImageDragEnter);t.loader=new BX.Loader({target:t.preview});t.icon=d.createIcon();t.image=d.createImageLayout();t.image.appendChild(t.preview);t.image.appendChild(t.icon);t.image.dataset.fileid=t.content.id;t.image.dataset.fileid2x=t.content.id2x;t.hiddenImage=i.Dom.create("img",{props:{className:"landing-ui-field-image-hidden"}});if(i.Type.isPlainObject(t.content)&&"src"in t.content){t.hiddenImage.src=t.content.src}t.altField=d.createAltField();t.altField.setValue(t.content.alt);t.left=d.createLeftLayout();t.left.appendChild(t.dropzone);t.left.appendChild(t.image);t.left.appendChild(t.hiddenImage);if(t.description){t.left.appendChild(t.description)}t.left.appendChild(t.altField.layout);t.left.appendChild(t.linkInput.layout);t.uploadButton=d.createUploadButton();t.uploadButton.on("click",t.onUploadClick.bind(babelHelpers.assertThisInitialized(t)));t.editButton=d.createEditButton();t.editButton.on("click",t.onEditClick.bind(babelHelpers.assertThisInitialized(t)));t.right=d.createRightLayout();t.right.appendChild(t.uploadButton.layout);t.right.appendChild(t.editButton.layout);t.form=d.createForm();t.form.appendChild(t.left);t.form.appendChild(t.right);t.layout.appendChild(t.form);t.enableTextOnly();if(!t.input.innerText.trim()||t.input.innerText.trim()===window.location.toString()){t.showDropzone()}if(t.disableAltField){t.altField.layout.hidden=true;t.altField.layout.style.display="none";t.altField.layout.classList.add("landing-ui-hide")}if(t.content.type==="icon"){t.type="icon";t.classList=t.content.classList;var a=t.content.classList;var o=[];s.IconPanel.getLibraries().then(function(e){e.forEach(function(e){e.categories.forEach(function(e){e.items.forEach(function(e){var i="";if(BX.Type.isObject(e)){i=e.options.join(" ");if(e.previousVersion){i+=" "+e.previousVersion}}else{i=e}var t=i.split(" ");t.forEach(function(e){if(a.indexOf(e)!==-1&&o.indexOf(e)===-1){o.push(e)}})})})});this.icon.innerHTML='<span class="'+o.join(" ")+'"></span>'}.bind(babelHelpers.assertThisInitialized(t)));t.showPreview();t.altField.layout.hidden=true}t.makeAsLinkWrapper=i.Dom.create("div",{props:{className:"landing-ui-field-image-make-as-link-wrapper"},children:[i.Dom.create("div",{props:{className:"landing-ui-field-image-make-as-link-button"},children:[]})]});t.url=new BX.Landing.UI.Field.Link({content:t.content.url||{text:"",href:""},options:{siteId:n.Main.getInstance().options.site_id,landingId:n.Main.getInstance().id},contentRoot:t.contentRoot});t.urlCheckbox=i.Dom.create("input",{props:{type:"checkbox"},attrs:{style:"margin-left: 4px;"}});function r(e,i){if(e.checked){i.querySelector(".landing-ui-field-link-right").classList.remove("landing-ui-disabled");i.querySelector(".landing-ui-field-link-url-grid").classList.remove("landing-ui-disabled")}else{i.querySelector(".landing-ui-field-link-right").classList.add("landing-ui-disabled");i.querySelector(".landing-ui-field-link-url-grid").classList.add("landing-ui-disabled")}}t.urlCheckbox.addEventListener("change",function(){r(this.urlCheckbox,this.url.layout)}.bind(babelHelpers.assertThisInitialized(t)));t.urlCheckbox.checked=t.content.url&&t.content.url.enabled;r(t.urlCheckbox,t.url.layout);t.url.hrefInput.header.appendChild(t.urlCheckbox);t.url.left.hidden=true;t.makeAsLinkWrapper.appendChild(t.url.layout);if(!e.disableLink){t.layout.appendChild(t.makeAsLinkWrapper)}t.content=t.getValue();BX.DOM.write(function(){this.adjustPreviewBackgroundSize()}.bind(babelHelpers.assertThisInitialized(t)));if(t.getValue().type==="background"||t.allowClear){t.clearButton.layout.classList.add("landing-ui-show")}t.uploader=new l.ImageUploader({uploadParams:t.uploadParams,additionalParams:{context:"imageeditor"},dimensions:t.dimensions,sizes:["1x","2x"]});t.adjustEditButtonState();return t}babelHelpers.createClass(d,[{key:"onInputInput",value:function e(){this.preview.src=this.input.innerText.trim()}},{key:"onImageDragEnter",value:function e(i){i.preventDefault();i.stopPropagation();if(!this.imageHidden){this.showDropzone();this.imageHidden=true}}},{key:"onDragOver",value:function e(i){i.preventDefault();i.stopPropagation();this.dropzone.classList.add("landing-ui-active")}},{key:"onDragLeave",value:function e(i){i.preventDefault();i.stopPropagation();this.dropzone.classList.remove("landing-ui-active");if(this.imageHidden){this.imageHidden=false;this.showPreview()}}},{key:"onDrop",value:function e(i){i.preventDefault();i.stopPropagation();this.dropzone.classList.remove("landing-ui-active");this.onFileChange(i.dataTransfer.files[0]);this.imageHidden=false}},{key:"onFileChange",value:function e(i){this.showLoader();this.upload(i).then(this.setValue.bind(this)).then(this.hideLoader.bind(this)).catch(function(e){console.error(e);this.hideLoader()}.bind(this))}},{key:"onFileInputChange",value:function e(i){this.onFileChange(i.currentTarget.files[0])}},{key:"onUploadClick",value:function e(i){this.bindElement=i.currentTarget;i.preventDefault();if(!this.uploadMenu){this.uploadMenu=BX.Main.MenuManager.create({id:"upload_"+this.selector+ +new Date,bindElement:this.bindElement,bindOptions:{forceBindPosition:true},items:[{text:t.Loc.getMessage("LANDING_IMAGE_UPLOAD_MENU_UNSPLASH"),onclick:this.onUnsplashShow.bind(this)},{text:t.Loc.getMessage("LANDING_IMAGE_UPLOAD_MENU_GOOGLE"),onclick:this.onGoogleShow.bind(this)},{text:t.Loc.getMessage("LANDING_IMAGE_UPLOAD_MENU_UPLOAD"),onclick:this.onUploadShow.bind(this)},{text:t.Loc.getMessage("LANDING_IMAGE_UPLOAD_MENU_LINK"),onclick:this.onLinkShow.bind(this)}],events:{onPopupClose:function(){this.bindElement.classList.remove("landing-ui-active");if(this.uploadMenu){this.uploadMenu.destroy();this.uploadMenu=null}}.bind(this)},targetContainer:this.contentRoot});if(!this.contentRoot){this.bindElement.parentNode.appendChild(this.uploadMenu.popupWindow.popupContainer)}}this.bindElement.classList.add("landing-ui-active");this.uploadMenu.toggle();if(!this.contentRoot){var n=BX.pos(this.bindElement,this.bindElement.parentNode);this.uploadMenu.popupWindow.popupContainer.style.top=n.bottom+"px";this.uploadMenu.popupWindow.popupContainer.style.left="auto";this.uploadMenu.popupWindow.popupContainer.style.right="5px"}}},{key:"onUnsplashShow",value:function e(){this.uploadMenu.close();BX.Landing.UI.Panel.Image.getInstance().show("unsplash",this.dimensions,this.loader,this.uploadParams).then(this.upload.bind(this)).then(this.setValue.bind(this)).then(this.hideLoader.bind(this)).catch(function(e){console.error(e);this.hideLoader()}.bind(this))}},{key:"onGoogleShow",value:function e(){this.uploadMenu.close();BX.Landing.UI.Panel.Image.getInstance().show("google",this.dimensions,this.loader,this.uploadParams).then(this.upload.bind(this)).then(this.setValue.bind(this)).then(this.hideLoader.bind(this)).catch(function(e){BX.Landing.ErrorManager.getInstance().add({type:"error",action:"BAD_IMAGE",hideSupportLink:true});console.error(e);this.hideLoader()}.bind(this))}},{key:"onUploadShow",value:function e(){this.uploadMenu.close();this.fileInput.click()}},{key:"onLinkShow",value:function e(){this.uploadMenu.close();this.showLinkField();this.linkInput.setValue("")}},{key:"onEditClick",value:function e(i){i.preventDefault();this.edit({src:this.hiddenImage.src})}},{key:"onClearClick",value:function e(i){i.preventDefault();this.setValue({src:""});this.fileInput.value="";this.showDropzone()}},{key:"showDropzone",value:function e(){this.dropzone.hidden=false;this.image.hidden=true;this.altField.layout.hidden=true;this.linkInput.layout.hidden=true}},{key:"showPreview",value:function e(){this.dropzone.hidden=true;this.image.hidden=false;this.altField.layout.hidden=false;this.linkInput.layout.hidden=true}},{key:"showLinkField",value:function e(){this.dropzone.hidden=true;this.image.hidden=true;this.altField.layout.hidden=true;this.linkInput.layout.hidden=false}},{key:"onLinkInput",value:function e(t){var n=i.Dom.create("img");n.src=t;n.onload=function(){this.showPreview();this.setValue({src:t,src2x:t})}.bind(this)}},{key:"showLoader",value:function e(){if(this.dropzone&&!this.dropzone.hidden){this.loader.show(this.dropzone);return}this.loader.show(this.preview)}},{key:"hideLoader",value:function e(){this.loader.hide()}},{key:"onInputClick",value:function e(i){i.preventDefault()}},{key:"isChanged",value:function e(){var t=BX.Landing.Utils.clone(this.content);var n=BX.Landing.Utils.clone(this.getValue());if(t.url&&i.Type.isString(t.url)){t.url=BX.Landing.Utils.decodeDataValue(t.url)}if(n.url&&i.Type.isString(n.url)){n.url=BX.Landing.Utils.decodeDataValue(n.url)}return JSON.stringify(t)!==JSON.stringify(n)}},{key:"adjustPreviewBackgroundSize",value:function e(){var t=i.Dom.create("img",{attrs:{src:this.getValue().src}});t.onload=function(){var e=this.preview.getBoundingClientRect();var i="cover";if(t.width>e.width||t.height>e.height){i="contain"}if(t.width<e.width&&t.height<e.height){i="auto"}BX.DOM.write(function(){this.preview.style.backgroundSize=i}.bind(this))}.bind(this)}},{key:"setValue",value:function e(i,t){if(i.type!=="icon"){if(!i||!i.src){this.input.innerText="";this.input2x.innerText="";this.preview.removeAttribute("style");this.input.dataset.ext="";this.showDropzone()}else{this.input.innerText=i.src;this.input2x.innerText=i.src2x||"";this.preview.style.backgroundImage='url("'+(i.src2x||i.src)+'")';this.preview.id=BX.util.getRandomString();this.hiddenImage.src=i.src2x||i.src;this.showPreview()}this.image.dataset.fileid=i&&i.id?i.id:-1;this.image.dataset.fileid2x=i&&i.id2x?i.id2x:-1;this.classList=[]}else{this.preview.style.backgroundImage=null;this.classList=i.classList;this.icon.innerHTML='<span class="'+i.classList.join(" ")+'"></span>';this.showPreview();this.type="icon";this.altField.layout.hidden=true;this.altField.setValue("");this.input.innerText=""}if(i.url){this.url.setValue(i.url)}this.adjustPreviewBackgroundSize();this.adjustEditButtonState();this.hideLoader();this.onValueChangeHandler(this);BX.fireEvent(this.layout,"input");var n=new BX.Event.BaseEvent({data:{value:this.getValue()},compatData:[this.getValue()]});if(!t){this.emit("change",n)}}},{key:"adjustEditButtonState",value:function e(){var i=this.getValue();if(BX.Type.isStringFilled(i.src)){this.editButton.enable()}else{this.editButton.disable()}}},{key:"reset",value:function e(){this.setValue({type:this.getValue().type,id:-1,src:"",alt:""})}},{key:"getValue",value:function e(){var i=parseInt(this.image.dataset.fileid);var t=parseInt(this.image.dataset.fileid2x);i=i===i?i:-1;t=t===t?t:-1;var n={type:"",src:"",id:i,id2x:t,src2x:"",alt:"",url:""};if(this.type==="background"){n.type="background";n.src=this.input.innerText.trim();n.src2x=this.input2x.innerText.trim();n.id=i;n.id2x=t}if(this.type==="image"){n.type="image";n.src=this.input.innerText.trim();n.src2x=this.input2x.innerText.trim();n.id=i;n.id2x=t;n.alt=this.altField.getValue()}if(this.type==="icon"){n.type="icon";n.classList=this.classList}n.url=Object.assign({},this.url.getValue(),{enabled:this.urlCheckbox.checked});return n}},{key:"edit",value:function e(i){r.ImageEditor.edit({image:i.src,dimensions:this.dimensions}).then(function(e){return this.upload(e,{context:"imageEditor"})}.bind(this)).then(function(e){this.setValue(e)}.bind(this));var t=new d;var n="/bitrix/images/landing/close.svg";n=BX.util.add_url_param(n,{action:"openImageEditor"});t.src=n+"?"+ +new Date}},{key:"upload",value:function e(i,t){if(i.type&&(i.type.includes("text")||i.type.includes("html"))){BX.Landing.ErrorManager.getInstance().add({type:"error",action:"BAD_IMAGE"});return Promise.reject({type:"error",action:"BAD_IMAGE"})}this.showLoader();var n=new Promise(function(e){var t=["1x","2x"];if(this.create2xByDefault===false){var n=new d;var a=URL.createObjectURL(i);var s=this.dimensions;n.onload=function(){URL.revokeObjectURL(a);if((this.width>=s.width||this.height>=s.height||this.width>=s.maxWidth||this.height>=s.maxHeight)===false){t=["1x"]}e(t)};n.src=a}else{e(t)}}.bind(this));return n.then(function(e){var n=function(){if(this.create2xByDefault===false&&BX.Type.isArrayFilled(e)){return e}return["1x","2x"]}.bind(this)();return this.uploader.setSizes(n).upload(i,t).then(function(e){this.hideLoader();if(n.length===1){return e[0]}return Object.assign({},e[0],{src2x:e[1].src,id2x:e[1].id})}.bind(this))}.bind(this))}}],[{key:"createFileInput",value:function e(t){return i.Dom.create("input",{props:{className:"landing-ui-field-image-dropzone-input"},attrs:{accept:"image/*",type:"file",id:"file_"+t,name:"picture"}})}},{key:"createLinkInput",value:function e(){var i=new a.TextField({id:"path_to_image",placeholder:t.Loc.getMessage("LANDING_IMAGE_UPLOAD_MENU_LINK_LABEL")});i.enableTextOnly();i.layout.hidden=true;return i}},{key:"createDropzone",value:function e(n){return i.Dom.create("label",{props:{className:"landing-ui-field-image-dropzone"},children:[i.Dom.create("div",{props:{className:"landing-ui-field-image-dropzone-text"},html:'<div class="landing-ui-field-image-dropzone-title">'+t.Loc.getMessage("LANDING_IMAGE_DROPZONE_TITLE")+"</div>"+'<div class="landing-ui-field-image-dropzone-subtitle">'+t.Loc.getMessage("LANDING_IMAGE_DROPZONE_SUBTITLE")+"</div>"})],attrs:{for:"file_"+n}})}},{key:"createClearButton",value:function e(){return new o.BaseButton("clear",{className:"landing-ui-field-image-action-button-clear"})}},{key:"createImagePreview",value:function e(){return i.Dom.create("div",{props:{className:"landing-ui-field-image-preview-inner"}})}},{key:"createIcon",value:function e(){return i.Dom.create("span",{props:{className:"landing-ui-field-image-preview-icon"}})}},{key:"createImageLayout",value:function e(){return i.Dom.create("div",{props:{className:"landing-ui-field-image-preview"}})}},{key:"createAltField",value:function e(){var i=new a.TextField({placeholder:t.Loc.getMessage("LANDING_FIELD_IMAGE_ALT_PLACEHOLDER"),className:"landing-ui-field-image-alt",textOnly:true});return i}},{key:"createLeftLayout",value:function e(){return i.Dom.create("div",{props:{className:"landing-ui-field-image-left"}})}},{key:"createUploadButton",value:function e(){return new o.BaseButton("upload",{text:t.Loc.getMessage("LANDING_FIELD_IMAGE_UPLOAD_BUTTON"),className:"landing-ui-field-image-action-button"})}},{key:"createEditButton",value:function e(){var i=new o.BaseButton("edit",{text:t.Loc.getMessage("LANDING_FIELD_IMAGE_EDIT_BUTTON"),className:"landing-ui-field-image-action-button"});return i}},{key:"createRightLayout",value:function e(){return i.Dom.create("div",{props:{className:"landing-ui-field-image-right"}})}},{key:"createForm",value:function e(){return i.Dom.create("form",{props:{className:"landing-ui-field-image-container"},attrs:{method:"post",enctype:"multipart/form-data"},events:{submit:function e(i){i.preventDefault()}}})}}]);return d}(a.TextField);e.Image=d})(this.BX.Landing.UI.Field=this.BX.Landing.UI.Field||{},BX,BX.Landing,BX.Landing,BX.Landing.UI.Field,BX.Landing.UI.Panel,BX.Landing,BX.Landing.UI.Button,BX.Landing);
//# sourceMappingURL=image.bundle.map.js