this.BX=this.BX||{};this.BX.Landing=this.BX.Landing||{};this.BX.Landing.Ui=this.BX.Landing.Ui||{};this.BX.Landing.Ui.Panel=this.BX.Landing.Ui.Panel||{};this.BX.Landing.Ui.Panel.Formsettingspanel=this.BX.Landing.Ui.Panel.Formsettingspanel||{};(function(e,t,n,i,a,o,r,s,l,u,d,c,g,p,v){"use strict";var f=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(f,"TYPE_0",0);babelHelpers.defineProperty(f,"TYPE_1",1);babelHelpers.defineProperty(f,"TYPE_2",2);function h(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div\n\t\t\t\t\tclass="landing-ui-field-element-','"\n\t\t\t\t\tdata-field-id="','"\n\t\t\t\t>\n\t\t\t\t\t','\n\t\t\t\t\t<div class="landing-ui-field-element-text">\n\t\t\t\t\t\t',"\n\t\t\t\t\t\t","\n\t\t\t\t\t</div>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t"]);h=function t(){return e};return e}function y(){var e=babelHelpers.taggedTemplateLiteral(['<div class="landing-ui-field-element-text-title">',"</div>"]);y=function t(){return e};return e}function b(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="landing-ui-field-element-text-action">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t"]);b=function t(){return e};return e}var m={removable:true,draggable:false,color:"blue"};var L=function(e){babelHelpers.inherits(t,e);function t(e){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));n.setEventNamespace("BX.Landing.UI.Field.RuleField.FieldElement");n.subscribeFromOptions(g.fetchEventsFromOptions(e));n.options=babelHelpers.objectSpread({},m,e);n.cache=new c.Cache.MemoryCache;return n}babelHelpers.createClass(t,[{key:"getDragButtonLayout",value:function e(){return this.cache.remember("dragButton",function(){var e=new r.IconButton({type:r.IconButton.Types.drag,style:{width:"20px"}});return e.getLayout()})}},{key:"getActionsDropdown",value:function e(){var t=this;return this.cache.remember("actionsDropdown",function(){var e=new window.top.BX.Landing.UI.Field.DropdownInline({title:t.options.actionsLabel,items:t.options.actionsList,content:t.options.actionsValue});e.subscribe("onChange",function(){t.emit("onChange")});return e})}},{key:"getActionsLayout",value:function e(){var t=this;return this.cache.remember("actionsLayout",function(){return c.Tag.render(b(),t.getActionsDropdown().getLayout())})}},{key:"getTitleLayout",value:function e(){var t=this;return this.cache.remember("titleLayout",function(){return c.Tag.render(y(),c.Text.encode(t.options.title))})}},{key:"getRemoveButtonLayout",value:function e(){var t=this;return this.cache.remember("removeButton",function(){var e=new r.IconButton({type:r.IconButton.Types.remove,onClick:function e(){return t.emit("onRemove")},iconSize:"9px",style:{width:"20px",marginLeft:"auto"}});return e.getLayout()})}},{key:"getLayout",value:function e(){var t=this;return this.cache.remember("layout",function(){return c.Tag.render(h(),t.options.color,c.Text.encode(t.options.id),t.options.draggable?t.getDragButtonLayout():"",t.options.actionsLabel?t.getActionsLayout():"",t.getTitleLayout(),t.options.removable?t.getRemoveButtonLayout():"")})}}]);return t}(d.EventEmitter);babelHelpers.defineProperty(L,"Colors",{blue:"blue",green:"green",red:"red"});function T(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div\n\t\t\t\t\tclass="landing-ui-rule-value"\n\t\t\t\t\tdata-target="','"\n\t\t\t\t>\n\t\t\t\t\t<div class="landing-ui-rule-value-text">\n\t\t\t\t\t\t',"\n\t\t\t\t\t\t",'\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="landing-ui-rule-value-actions">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="landing-ui-rule-decoration">\n\t\t\t\t\t\t<div class="landing-ui-rule-decoration-v-line"></div>\n\t\t\t\t\t\t<div class="landing-ui-rule-decoration-h-line"></div>\n\t\t\t\t\t\t<div class="landing-ui-rule-decoration-arrow"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t']);T=function t(){return e};return e}function E(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="value-settings-item value-settings-item-value">\n\t\t\t\t<input\n\t\t\t\t\ttype="radio"\n\t\t\t\t\tid="value_',"_",'"\n\t\t\t\t\tname="value_',"_",'"\n\t\t\t\t\tonchange="','"\n\t\t\t\t\t','\n\t\t\t\t>\n\t\t\t\t<label for="value_',"_",'">',"</label>\n\t\t\t</div>\n\t\t"]);E=function t(){return e};return e}function C(){var e=babelHelpers.taggedTemplateLiteral(['<div class="value-settings-popup"></div>']);C=function t(){return e};return e}function I(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div\n\t\t\t\t\tclass="landing-ui-rule-value-value-label"\n\t\t\t\t\tonclick="','"\n\t\t\t\t>\n\t\t\t\t\t<span class="landing-ui-rule-value-value-label-inner">',"</span>\n\t\t\t\t</div>\n\t\t\t"]);I=function t(){return e};return e}function F(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div\n\t\t\t\t\tclass="landing-ui-rule-value-operator-label"\n\t\t\t\t\tonclick="','"\n\t\t\t\t>',"</div>\n\t\t\t"]);F=function t(){return e};return e}var _=function(e){babelHelpers.inherits(t,e);function t(e){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"cache",new c.Cache.MemoryCache);n.setEventNamespace("BX.Landing.UI.Panel.FormSettingsPanel.ValueElement");n.options=babelHelpers.objectSpread({},e);n.state=babelHelpers.objectSpread({},n.options.data);return n}babelHelpers.createClass(t,[{key:"getOperatorLabelLayout",value:function e(){var t=this;return this.cache.remember("operatorLabelLayout",function(){var e=t.getOperatorLabelText(t.options.data.operation);return c.Tag.render(F(),t.onOperatorLabelClick.bind(t),e)})}},{key:"onOperatorLabelClick",value:function e(t){t.preventDefault();this.getOperatorSettingsPopup().show()}},{key:"getTargetContainer",value:function e(){var t=this;return this.cache.remember("targetContainer",function(){return t.getLayout().closest(".landing-ui-panel-content-body-content")||t.getLayout()})}},{key:"getOperatorSettingsPopup",value:function e(){var t=this;return this.cache.remember("operatorSettingsPopup",function(){var e=l.PageObject.getRootWindow();return new e.BX.Main.Popup({bindElement:t.getLayout(),targetContainer:t.getTargetContainer(),content:t.getOperatorField().getLayout(),autoHide:true,minWidth:160,offsetLeft:20,offsetTop:3,bindOptions:{position:"bottom"}})})}},{key:"getValueLabelLayout",value:function e(){var t=this;return this.cache.remember("valueLabelLayout",function(){var e=t.getValueLabelText(t.options.data.value);var n=c.Tag.render(I(),t.onValueLabelClick.bind(t),c.Text.encode(e));if(t.options.data.operation==="any"||t.options.data.operation==="empty"){c.Dom.hide(n)}return n})}},{key:"setValueLabelText",value:function e(t){this.getValueLabelLayout().firstElementChild.textContent=t}},{key:"onValueLabelClick",value:function e(t){t.preventDefault();this.getValueSettingsPopup().show()}},{key:"getValueSettingsPopup",value:function e(){var t=this;return this.cache.remember("valueSettingsPopup",function(){var e=l.PageObject.getRootWindow();var n=c.Tag.render(C());var i=c.Text.getRandom();var a=t.getTargetField();if(a.type==="list"||a.type==="product"||a.type==="checkbox"||a.type==="radio"||a.type==="bool"){var o=function(){if(a.type==="bool"){return[{label:v.Loc.getMessage("LANDING_RULE_FIELD_CONDITION_VALUE_YES"),value:"Y"},{label:v.Loc.getMessage("LANDING_RULE_FIELD_CONDITION_VALUE_NO"),value:"N"}]}return a.items}();o.forEach(function(e){var o=String(a.value)===String(e.value);c.Dom.append(c.Dom.append(t.renderValueRadioButton(babelHelpers.objectSpread({},e,{id:i,checked:o})),n),n)})}else{var r=function(){if(c.Type.isStringFilled(t.options.data.value)){return t.getValueLabelText(t.options.data.value)}return""}();var s=new u.TextField({textOnly:true,onValueChange:function e(){var n=s.getValue()||v.Loc.getMessage("LANDING_RULE_CONDITION_VALUE_EMPTY");t.setValueLabelText(n);t.state.value=s.getValue();t.emit("onChange")},content:r});c.Dom.append(s.getLayout(),n)}return new e.BX.Main.Popup({bindElement:t.getLayout(),targetContainer:t.getTargetContainer(),content:n,width:228,autoHide:true,maxHeight:200,offsetLeft:20,offsetTop:3,events:{onShow:function e(){c.Dom.addClass(t.getLayout(),"landing-ui-rule-value-active")},onClose:function e(){c.Dom.removeClass(t.getLayout(),"landing-ui-rule-value-active")}}})})}},{key:"renderValueRadioButton",value:function e(t){var n=this;var i=t.label,a=t.value,o=t.id,r=t.checked;var s=function e(){n.setValueLabelText(i);n.state.value=a;n.emit("onChange")};return c.Tag.render(E(),o,a,o,this.options.data.target,s,r?"checked":"",o,a,c.Text.encode(i))}},{key:"getOperatorField",value:function e(){var t=this;return this.cache.remember("operatorField",function(){var e=t.options.dictionary.deps.condition;var n=t.getTargetField();return new BX.Landing.UI.Field.Radio({selector:"operation",value:[t.state.operation],items:e.operations.filter(function(e){return(!c.Type.isArrayFilled(e.fieldTypes)||e.fieldTypes.includes(n.type))&&(!c.Type.isArrayFilled(e.excludeFieldTypes)||c.Type.isArrayFilled(e.excludeFieldTypes)&&!e.excludeFieldTypes.includes(n.type))}).map(function(e){return{name:e.name,value:e.id}}),onChange:t.onOperationChange.bind(t)})})}},{key:"setOperationLabelText",value:function e(t){this.getOperatorLabelLayout().textContent=t}},{key:"onOperationChange",value:function e(){var t=this.getOperatorField();var n=t.getValue(),i=babelHelpers.slicedToArray(n,1),a=i[0];if(a==="empty"||a==="any"){c.Dom.hide(this.getValueLabelLayout())}else{c.Dom.show(this.getValueLabelLayout())}this.setOperationLabelText(this.getOperatorLabelText(a));this.state.operation=a;this.emit("onChange")}},{key:"getRemoveButton",value:function e(){var t=this;return this.cache.remember("removeButton",function(){return new r.IconButton({type:r.IconButton.Types.remove,iconSize:"9px",style:{width:"19px",marginLeft:"auto"},onClick:function e(){t.emit("onRemove");t.emit("onChange")}})})}},{key:"getLayout",value:function e(){var t=this;return this.cache.remember("layout",function(){return c.Tag.render(T(),c.Text.encode(t.options.data.target),t.getOperatorLabelLayout(),t.getValueLabelLayout(),t.options.removable?t.getRemoveButton().getLayout():"")})}},{key:"getOperatorLabelText",value:function e(t){return this.options.dictionary.deps.condition.operations.reduce(function(e,n){if(n.id===t){return n.name}return e},this.options.dictionary.deps.condition.operations[0].name)}},{key:"getTargetField",value:function e(){var t=this;return this.cache.remember("targetField",function(){return t.options.fields.find(function(e){return String(e.id)===String(t.options.data.target)})})}},{key:"getValueLabelText",value:function e(t){var n=this.getTargetField();if(c.Type.isPlainObject(n)){if(c.Type.isArrayFilled(n.items)){var i=n.items.find(function(e){return String(e.value)===String(t)});if(c.Type.isPlainObject(i)){return i.label}}if(c.Type.isStringFilled(t)){if(t==="Y"){return v.Loc.getMessage("LANDING_RULE_CONDITION_VALUE_YES")}if(t==="N"){return v.Loc.getMessage("LANDING_RULE_CONDITION_VALUE_NO")}return t}}return v.Loc.getMessage("LANDING_RULE_CONDITION_VALUE_EMPTY")}},{key:"getValue",value:function e(){return babelHelpers.objectSpread({},this.state)}}]);return t}(d.EventEmitter);function A(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="landing-ui-rule-entry-type-separator">\n\t\t\t\t\t<div class="landing-ui-rule-entry-type-separator-inner">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t"]);A=function t(){return e};return e}var k=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"cache",new c.Cache.MemoryCache);this.options=babelHelpers.objectSpread({},t)}babelHelpers.createClass(e,[{key:"getLayout",value:function e(){var t=this;return this.cache.remember("layout",function(){return c.Tag.render(A(),t.getSeparatorLabel())})}},{key:"getSeparatorLabel",value:function e(){if(String(this.options.typeId)===String(2)){return v.Loc.getMessage("LANDING_RULE_TYPE_SEPARATOR_TYPE_2")}return v.Loc.getMessage("LANDING_RULE_TYPE_SEPARATOR_TYPE_1")}}]);return e}();function D(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="landing-ui-rule-entry-add-expression-field-link">\n\t\t\t\t\t<div class="landing-ui-rule-entry-add-expression-field-link-action-panel">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="landing-ui-rule-entry-add-expression-field-link-separator"></div>\n\t\t\t\t</div>\n\t\t\t']);D=function t(){return e};return e}function R(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="landing-ui-rule-entry">\n\t\t\t\t\t','\n\t\t\t\t\t<div class="landing-ui-rule-entry-body">\n\t\t\t\t\t\t',"\n\t\t\t\t\t\t","\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t"]);R=function t(){return e};return e}function H(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="landing-ui-rule-entry-header">',"</div>\n\t\t\t"]);H=function t(){return e};return e}function P(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="landing-ui-rule-entry-expressions">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t"]);P=function t(){return e};return e}function N(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="landing-ui-rule-entry-conditions"></div>\n\t\t\t']);N=function t(){return e};return e}var x=function(e){babelHelpers.inherits(t,e);function t(e){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"conditions",[]);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"expressions",[]);n.setEventNamespace("BX.Landing.UI.Panel.FormSettingsPanel.RuleEntry");n.options=babelHelpers.objectSpread({enableHeader:true,expressions:[]},e);n.cache=new c.Cache.MemoryCache;n.onConditionFieldValueRemove=n.onConditionFieldValueRemove.bind(babelHelpers.assertThisInitialized(n));n.onConditionFieldRemove=n.onConditionFieldRemove.bind(babelHelpers.assertThisInitialized(n));if(c.Type.isArrayFilled(n.options.conditions)){n.options.conditions.forEach(function(e){n.addCondition(e)});n.options.expressions.forEach(function(e){n.addExpression(e)})}return n}babelHelpers.createClass(t,[{key:"getConditionsLayout",value:function e(){return this.cache.remember("conditionsLayout",function(){return c.Tag.render(N())})}},{key:"getExpressionsLayout",value:function e(){var t=this;return this.cache.remember("expressionsLayout",function(){return c.Tag.render(P(),t.getAddExpresionFieldLinkLayout())})}},{key:"getHeaderLayout",value:function e(){return this.cache.remember("headerLayout",function(){return c.Tag.render(H(),v.Loc.getMessage("LANDING_RULE_ENTRY_HEADER"))})}},{key:"getLayout",value:function e(){var t=this;return this.cache.remember("layout",function(){return c.Tag.render(R(),t.options.enableHeader?t.getHeaderLayout():"",t.getConditionsLayout(),t.getExpressionsLayout())})}},{key:"onConditionFieldRemove",value:function e(t){var n=t.getTarget();var i=n.getLayout();this.conditions=this.conditions.filter(function(e){return e!==n});var a=i.nextElementSibling;while(c.Type.isDomNode(a)&&!a.matches('[class*="landing-ui-field-element"]')){this.conditions=this.conditions.filter(function(e){return e.getLayout()!==a});c.Dom.remove(a);a=i.nextElementSibling}if(!c.Type.isDomNode(a)){var o=i.previousElementSibling;if(c.Type.isDomNode(o)&&c.Dom.hasClass(o,"landing-ui-rule-entry-type-separator")){c.Dom.remove(o)}}c.Dom.remove(i);this.emit("onChange")}},{key:"onConditionFieldValueRemove",value:function e(t){var n=t.getTarget();var i=n.getLayout();this.conditions=this.conditions.filter(function(e){return e!==n});if(c.Dom.hasClass(i.nextElementSibling,"landing-ui-rule-entry-type-separator")){c.Dom.remove(i.nextElementSibling)}else if(c.Dom.hasClass(i.previousElementSibling,"landing-ui-rule-entry-type-separator")){c.Dom.remove(i.previousElementSibling)}c.Dom.remove(i)}},{key:"addCondition",value:function e(t){var n=this;if(!this.conditions.includes(t)){this.conditions.push(t);if(t instanceof _){t.subscribe("onRemove",this.onConditionFieldValueRemove);t.subscribe("onChange",function(){return n.emit("onChange")});var i=babelHelpers.toConsumableArray(this.getConditionsLayout().childNodes);var a=i.reduce(function(e,n){if(c.Dom.hasClass(n,"landing-ui-rule-value")&&String(c.Dom.attr(n,"data-target"))===String(t.options.data.target)||n.matches('[class*="landing-ui-field-element"]')&&String(c.Dom.attr(n,"data-field-id"))===String(t.options.data.target)){return n}return e},null);if(c.Type.isDomNode(a)){c.Dom.insertAfter(t.getLayout(),a);if(c.Dom.hasClass(a,"landing-ui-rule-value")){var o=new k({typeId:this.options.typeId});c.Dom.insertBefore(o.getLayout(),t.getLayout())}return}}if(t instanceof L){t.subscribe("onRemove",this.onConditionFieldRemove);t.subscribe("onChange",function(){return n.emit("onChange")});if(babelHelpers.toConsumableArray(this.getConditionsLayout().childNodes).length>0){var r=new k({typeId:this.options.typeId});c.Dom.append(r.getLayout(),this.getConditionsLayout())}}c.Dom.append(t.getLayout(),this.getConditionsLayout());this.emit("onChange")}}},{key:"getExpressionActionPanel",value:function e(){var t=this;return this.cache.remember("expressionActionPanel",function(){return new p.ActionPanel({left:[{id:"addField",text:v.Loc.getMessage("LANDING_RULE_ENTRY_ADD_FIELD_LABEL"),onClick:t.onAddExpressionFieldClick.bind(t)}]})})}},{key:"onAddExpressionFieldClick",value:function e(t){var n=this;t.preventDefault();var i=this.getFieldsListMenu();i.getMenuItems().forEach(function(e){var t=n.expressions.some(function(t){return String(t.options.id)===String(e.getId())});if(t){c.Dom.addClass(e.getLayout().item,"landing-ui-disabled")}else{c.Dom.removeClass(e.getLayout().item,"landing-ui-disabled")}});this.getFieldsListMenu().show()}},{key:"getExpressionAllowedFieldsList",value:function e(){var t=this;var n=["page","layout"];return this.options.fields.filter(function(e){if(!n.includes(e.type)){return!t.conditions.find(function(t){return c.Type.isPlainObject(t.options)&&(c.Type.isPlainObject(t.options.data)&&String(t.options.data.target)===String(e.id)||String(t.options.id)===String(e.id))})}return true})}},{key:"getFieldsListMenu",value:function e(){var t=this;return this.cache.remember("fieldsListMenu",function(){return new window.top.BX.Main.Menu({bindElement:t.getExpressionActionPanel().getLayout(),maxHeight:205,items:t.getExpressionAllowedFieldsList().map(function(e){return{id:e.id,text:e.label,onclick:t.onAddExpressionField.bind(t,e)}})})})}},{key:"getAddExpresionFieldLinkLayout",value:function e(){var t=this;return this.cache.remember("addExpressionFieldLinkLayout",function(){return c.Tag.render(D(),t.getExpressionActionPanel().getLayout())})}},{key:"onAddExpressionField",value:function e(t){var n=new L({id:t.id,title:t.label,removable:true,color:L.Colors.green,actionsLabel:v.Loc.getMessage("LANDING_RULE_EXPRESSION_FIELD_ACTION_LABEL"),actionsList:[{name:v.Loc.getMessage("LANDING_RULE_EXPRESSION_FIELD_ACTION_SHOW_LABEL"),value:"show"},{name:v.Loc.getMessage("LANDING_RULE_EXPRESSION_FIELD_ACTION_HIDE_LABEL"),value:"hide"}],actionsValue:"show"});this.addExpression(n);this.getFieldsListMenu().close();this.emit("onChange")}},{key:"onExpressionFieldRemove",value:function e(t){var n=t.getTarget();c.Dom.remove(n.getLayout());this.expressions=this.expressions.filter(function(e){return String(e.options.id)!==String(n.options.id)});this.adjustExpressionFieldsZIndexes();this.emit("onChange")}},{key:"onExpressionFieldChange",value:function e(){this.emit("onChange")}},{key:"adjustExpressionFieldsZIndexes",value:function e(){babelHelpers.toConsumableArray(this.getExpressionsLayout().children).reverse().forEach(function(e,t){if(e.matches('[class*="landing-ui-field-element"]')){c.Dom.style(e,"z-index",t+2)}})}},{key:"addExpression",value:function e(t){if(!this.expressions.includes(t)){this.expressions.push(t);t.subscribe("onRemove",this.onExpressionFieldRemove.bind(this));t.subscribe("onChange",this.onExpressionFieldChange.bind(this));void this.getLayout();c.Dom.insertBefore(t.getLayout(),this.getAddExpresionFieldLinkLayout());this.adjustExpressionFieldsZIndexes()}}},{key:"getValue",value:function e(){var t=this;return this.conditions.filter(function(e){return e instanceof _}).reduce(function(e,n){return[].concat(babelHelpers.toConsumableArray(e),babelHelpers.toConsumableArray(t.expressions.map(function(e){return{condition:babelHelpers.objectSpread({},n.getValue(),{event:"change"}),action:{target:e.options.id,type:e.getActionsDropdown().getValue()}}})))},[])}}]);return t}(d.EventEmitter);function S(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="landing-ui-rule-field-action-panel">\n\t\t\t\t\t','\n\t\t\t\t\t<div class="landing-ui-rule-field-action-panel-decoration">\n\t\t\t\t\t\t<div class="landing-ui-rule-field-action-panel-decoration-v-line"></div>\n\t\t\t\t\t\t<div class="landing-ui-rule-field-action-panel-decoration-h-line"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t']);S=function t(){return e};return e}var O=function(e){babelHelpers.inherits(t,e);function t(e){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"cache",new c.Cache.MemoryCache);n.setEventNamespace("BX.Landing.UI.FormSettingsPanel.FieldRules.FieldActionPanel");n.subscribeFromOptions(g.fetchEventsFromOptions(e));if(c.Type.isPlainObject(e.style)){c.Dom.style(n.getLayout(),e.style)}return n}babelHelpers.createClass(t,[{key:"getLayout",value:function e(){var t=this;return this.cache.remember("layout",function(){return c.Tag.render(S(),t.getActionPanel().getLayout())})}},{key:"getActionPanel",value:function e(){var t=this;return this.cache.remember("actionPanel",function(){return new p.ActionPanel({left:[{id:"addCondition",text:v.Loc.getMessage("LANDING_RULE_GROUP_ADD_FIELD_CONDITION"),onClick:function e(){t.emit("onAddCondition")}}]})})}}]);return t}(d.EventEmitter);function B(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="landing-ui-rule-group-footer">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t"]);B=function t(){return e};return e}function w(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="landing-ui-rule-group-body"></div>\n\t\t\t']);w=function t(){return e};return e}function U(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="landing-ui-rule-group-header-title">',"</div>\n\t\t\t"]);U=function t(){return e};return e}function M(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="landing-ui-rule-group-header">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t"]);M=function t(){return e};return e}var V=function(e){babelHelpers.inherits(t,e);function t(e){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));n.setEventNamespace("BX.Landing.UI.Panel.FormSettingsPanel.Content.FieldRules.RuleGroup");n.subscribeFromOptions(g.fetchEventsFromOptions(e));n.setLayoutClass("landing-ui-rule-group");var i=n.getLayout();c.Dom.clean(i);c.Dom.append(n.getHeaderLayout(),i);c.Dom.append(n.getBodyLayout(),i);c.Dom.append(n.getFooterLayout(),i);if(c.Type.isArrayFilled(n.options.data.list)){var a=n.options.data.list.filter(function(e){var t=n.getField(e.condition.target);var i=n.getField(e.action.target);return t&&i});if(n.getTypeId()===f.TYPE_0){var o=a.reduce(function(e,t){var n=t.condition,i=n.target,a=n.operation,o=n.value;if(!c.Type.isArray(e["".concat(i).concat(a).concat(o)])){e["".concat(i).concat(a).concat(o)]=[]}e["".concat(i).concat(a).concat(o)].push(t);return e},{});Object.values(o).forEach(function(e,t){var i=babelHelpers.slicedToArray(e,1),a=i[0];if(c.Type.isPlainObject(a)){var o=n.getField(a.condition.target);var r=new x({enableHeader:t===0,typeId:n.getTypeId(),fields:n.options.fields,onChange:function e(){return n.emit("onChange")},conditions:[new L({dictionary:n.options.dictionary,fields:n.options.fields,id:o.id,title:o.label,color:L.Colors.blue,onRemove:function e(){n.onConditionFieldRemove(r)}}),new _({dictionary:n.options.dictionary,fields:n.options.fields,removable:false,data:e[0].condition})],expressions:e.map(function(e){var t=n.getField(e.action.target);return new L({id:t.id,title:t.label,removable:true,color:L.Colors.green,actionsLabel:v.Loc.getMessage("LANDING_RULE_EXPRESSION_FIELD_ACTION_LABEL"),actionsList:[{name:v.Loc.getMessage("LANDING_RULE_EXPRESSION_FIELD_ACTION_SHOW_LABEL"),value:"show"},{name:v.Loc.getMessage("LANDING_RULE_EXPRESSION_FIELD_ACTION_HIDE_LABEL"),value:"hide"}],actionsValue:e.action.type})})});n.addEntry(r)}})}if(n.getTypeId()===f.TYPE_1||n.getTypeId()===f.TYPE_2){var r=new x({enableHeader:true,typeId:n.getTypeId(),fields:n.options.fields,onChange:function e(){return n.emit("onChange")}});var s=a.reduce(function(e,t){var n=t.condition.target;if(!c.Type.isArray(e[n])){e[n]=[]}e[n].push(t);return e},{});Object.values(s).forEach(function(e){var t=babelHelpers.slicedToArray(e,1),i=t[0];if(c.Type.isPlainObject(i)){var a=n.getField(i.condition.target);var o=n.getTypeId()===f.TYPE_2&&a.multiple||n.getTypeId()===f.TYPE_1;r.addCondition(new L({dictionary:n.options.dictionary,fields:n.options.fields,id:a.id,title:a.label,color:L.Colors.blue,onRemove:function e(){n.onConditionFieldRemove(r)}}));var s=e.reduce(function(e,t){e["".concat(t.condition.operation).concat(t.condition.value)]=t;return e},{});Object.values(s).forEach(function(e){r.addCondition(new _({dictionary:n.options.dictionary,fields:n.options.fields,removable:o,data:e.condition}))});r.addCondition(new O({style:{display:o?null:"none"},onAddCondition:function e(){n.onAddFieldCondition(new d.BaseEvent({data:{entry:r,target:a.id}}))}}))}});var l=Object.values(a).reduce(function(e,t){var n=t.action,i=n.target,a=n.type;e["".concat(i).concat(a)]=t;return e},{});Object.values(l).forEach(function(e){var t=n.getField(e.action.target);var i=new L({id:t.id,title:t.label,removable:true,color:L.Colors.green,actionsLabel:v.Loc.getMessage("LANDING_RULE_EXPRESSION_FIELD_ACTION_LABEL"),actionsList:[{name:v.Loc.getMessage("LANDING_RULE_EXPRESSION_FIELD_ACTION_SHOW_LABEL"),value:"show"},{name:v.Loc.getMessage("LANDING_RULE_EXPRESSION_FIELD_ACTION_HIDE_LABEL"),value:"hide"}],actionsValue:e.action.type});r.addExpression(i)});n.addEntry(r)}}return n}babelHelpers.createClass(t,[{key:"getEntries",value:function e(){return this.cache.remember("entries",function(){return[]})}},{key:"setEntries",value:function e(t){this.cache.set("entries",t)}},{key:"addEntry",value:function e(t){var n=this;if(t){var i=this.getEntries();if(!i.includes(t)){t.subscribe("onChange",function(){return n.emit("onChange")});i.push(t);c.Dom.append(t.getLayout(),this.getBodyLayout());this.emit("onChange")}}}},{key:"getHeaderLayout",value:function e(){var t=this;return this.cache.remember("headerLayout",function(){return c.Tag.render(M(),t.getHeaderTitleLayout(),t.getRemoveButtonLayout())})}},{key:"getHeaderTitleLayout",value:function e(){var t=this;return this.cache.remember("headerTitleLayout",function(){var e=v.Loc.getMessage("LANDING_FIELDS_RULES_TYPE_".concat(t.getTypeId()+1));return c.Tag.render(U(),e)})}},{key:"getRemoveButtonLayout",value:function e(){var t=this;return this.cache.remember("removeButtonLayout",function(){var e=new r.IconButton({type:r.IconButton.Types.remove,onClick:t.onRemoveClick.bind(t),title:v.Loc.getMessage("LANDING_RULE_GROUP_REMOVE_BUTTON_TITLE"),style:{marginLeft:"auto"}});return e.getLayout()})}},{key:"onRemoveClick",value:function e(){c.Dom.remove(this.getLayout());this.emit("onRemove");this.emit("onChange")}},{key:"getBodyLayout",value:function e(){return this.cache.remember("bodyLayout",function(){return c.Tag.render(w())})}},{key:"getFooterLayout",value:function e(){var t=this;return this.cache.remember("footerLayout",function(){return c.Tag.render(B(),t.getFooterActionPanel().getLayout())})}},{key:"getFooterActionPanel",value:function e(){var t=this;return this.cache.remember("footerActionPanel",function(){return new p.ActionPanel({left:[{id:"selectField",text:v.Loc.getMessage("LANDING_RULE_ENTRY_ADD_FIELD_LABEL"),onClick:t.onAddFieldClick.bind(t)}]})})}},{key:"onAddFieldClick",value:function e(t){var n=this.getFieldsListMenu();n.getPopupWindow().setBindElement(t.currentTarget);n.show()}},{key:"getFieldsListMenu",value:function e(){var t=this;return this.cache.remember("fieldsMenu",function(){return new window.top.BX.Main.Menu({maxHeight:205,items:t.options.fields.map(function(e){return{id:e.id,text:e.label,onclick:function n(){t.onFieldsListMenuItemClick(e);t.getFieldsListMenu().close()}}}),autoHide:true})})}},{key:"getDefaultValueState",value:function e(t){var n=this.options.fields.find(function(e){return String(e.id)===String(t)});if(n){var i=this.options.dictionary.deps.condition.operations.filter(function(e){return(!c.Type.isArrayFilled(e.fieldTypes)||e.fieldTypes.includes(n.type))&&(!c.Type.isArrayFilled(e.excludeFieldTypes)||c.Type.isArrayFilled(e.excludeFieldTypes)&&!e.excludeFieldTypes.includes(n.type))});if(c.Type.isArrayFilled(i)){return i[0].id}}return"="}},{key:"onAddFieldCondition",value:function e(t){var n=t.getData(),i=n.target,a=n.entry;a.addCondition(new _({dictionary:this.options.dictionary,fields:this.options.fields,removable:true,data:{target:i,operation:this.getDefaultValueState(i),value:null}}))}},{key:"onConditionFieldRemove",value:function e(t){var n=t.conditions.filter(function(e){return e instanceof L});if(n.length===1){var i=this.getEntries().filter(function(e){return t!==e});this.setEntries(i);c.Dom.remove(t.getLayout())}}},{key:"onFieldsListMenuItemClick",value:function e(t){var n=this;if(this.getTypeId()===f.TYPE_0){var i=this.getEntries().length===0;var a=new x({enableHeader:i,typeId:this.getTypeId(),fields:this.options.fields,conditions:[new L({dictionary:this.options.dictionary,fields:this.options.fields,id:t.id,title:t.label,color:L.Colors.blue,onRemove:function e(){n.onConditionFieldRemove(a)}}),new _({dictionary:this.options.dictionary,fields:this.options.fields,removable:false,data:{target:t.id,operation:this.getDefaultValueState(t.id),value:null}})],onChange:function e(){return n.emit("onChange")}});this.addEntry(a)}if(this.getTypeId()===f.TYPE_1||this.getTypeId()===f.TYPE_2){var o=this.getTypeId()===f.TYPE_2&&t.multiple||this.getTypeId()===f.TYPE_1;var r=[new L({dictionary:this.options.dictionary,fields:this.options.fields,id:t.id,title:t.label,color:L.Colors.blue,onRemove:function e(){n.onConditionFieldRemove(n.getEntries()[0])}}),new _({dictionary:this.options.dictionary,fields:this.options.fields,removable:o,data:{target:t.id,operation:this.getDefaultValueState(t.id),value:null}})];if(this.getTypeId()===f.TYPE_1||this.getTypeId()===f.TYPE_2){r.push(new O({style:{display:o?null:"none"},onAddCondition:function e(){n.onAddFieldCondition(new d.BaseEvent({data:{entry:n.getEntries()[0],target:t.id}}))}}))}var s=this.getEntries(),l=babelHelpers.slicedToArray(s,1),u=l[0];if(u){r.forEach(function(e){u.addCondition(e)})}else{var c=new x({enableHeader:true,typeId:this.getTypeId(),fields:this.options.fields,conditions:r,onChange:function e(){return n.emit("onChange")}});this.addEntry(c)}}}},{key:"getId",value:function e(){if(!c.Type.isNil(this.options.data.id)){return this.options.data.id}return 0}},{key:"getTypeId",value:function e(){return c.Text.toNumber(this.options.data.typeId)}},{key:"getLogic",value:function e(){return this.getTypeId()===f.TYPE_2?"and":"or"}},{key:"getValue",value:function e(){var t=this.getEntries().reduce(function(e,t){return[].concat(babelHelpers.toConsumableArray(e),babelHelpers.toConsumableArray(t.getValue()))},[]);return{id:this.getId(),typeId:this.getTypeId(),logic:this.getLogic(),list:t}}},{key:"getField",value:function e(t){return this.options.fields.find(function(e){return String(e.id)===String(t)})}}]);return t}(o.BaseField);var X=function(e){babelHelpers.inherits(t,e);function t(e){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));n.setEventNamespace("BX.Landing.UI.Panel.FormSettingsPanel.FieldsRulesContent");n.addItem(n.getHeader());if(!c.Type.isArrayFilled(n.options.formOptions.data.dependencies)){n.addItem(n.getRuleTypeField())}else{n.addItem(n.getRulesForm());n.addItem(n.getActionPanel())}return n}babelHelpers.createClass(t,[{key:"getHeader",value:function e(){return this.cache.remember("headerCard",function(){return new n.HeaderCard({title:c.Loc.getMessage("LANDING_FIELDS_RULES_TITLE")})})}},{key:"getRulesForm",value:function e(){var t=this;return this.cache.remember("rulesForm",function(){return new a.FormSettingsForm({selector:"dependencies",description:null,fields:t.options.formOptions.data.dependencies.map(function(e){return new V({dictionary:t.options.dictionary,fields:t.getFormFields(),data:e,onRemove:t.onRuleGroupRemove.bind(t)})})})})}},{key:"getActionPanel",value:function e(){var t=this;return this.cache.remember("actionPanel",function(){return new p.ActionPanel({left:[{text:c.Loc.getMessage("LANDING_FIELDS_ADD_NEW_RULE_LINK_LABEL"),onClick:t.onAddRuleClick.bind(t)}]})})}},{key:"onAddRuleClick",value:function e(){this.insertBefore(this.getRuleTypeField(),this.getActionPanel());this.items.remove(this.getActionPanel());c.Dom.remove(this.getActionPanel().getLayout());this.getActionPanel().unsubscribe("onChange",this.onChange)}},{key:"getRuleTypeField",value:function e(){var t=this;return this.cache.remember("ruleTypeField",function(){return new i.RadioButtonField({selector:"rules-type",items:Object.entries(f).map(function(e){var n=babelHelpers.slicedToArray(e,2),i=n[1];return{id:"ruleType".concat(i),icon:"landing-ui-rules-type".concat(i+1,"-icon"),title:c.Loc.getMessage("LANDING_FIELDS_RULES_TYPE_".concat(i+1)),button:{text:c.Loc.getMessage("LANDING_FIELDS_RULES_TYPE_BUTTON"),onClick:t.onCreateRuleButtonClick.bind(t,{type:i})}}})})})}},{key:"getFormFields",value:function e(){var t=this;var n=function(){if(!c.Type.isPlainObject(t.options.dictionary.deps.field)||!c.Type.isArrayFilled(t.options.dictionary.deps.field.disallowed)){return null}return t.options.dictionary.deps.field.disallowed}();return this.options.formOptions.data.fields.filter(function(e){return!c.Type.isArrayFilled(n)||!n.includes(e.type)&&(!c.Type.isPlainObject(e.content)||n.includes(e.content.type))})}},{key:"onCreateRuleButtonClick",value:function e(t){var n=t.type;this.clear();var i=this.getHeader();i.setBottomMargin(false);this.addItem(i);var a=this.getRulesForm();a.addField(new V({dictionary:this.options.dictionary,fields:this.getFormFields(),data:{id:0,typeId:n,list:[],logic:n===f.TYPE_2?"and":"or"},onRemove:this.onRuleGroupRemove.bind(this)}));this.addItem(a);this.addItem(this.getActionPanel())}},{key:"onRuleGroupRemove",value:function e(t){this.onChange(t);this.getRulesForm().removeField(t.getTarget());t.getTarget().unsubscribe("onChange",this.onChange)}},{key:"onChange",value:function e(t){this.emit("onChange",babelHelpers.objectSpread({},t.getData(),{skipPrepare:true}))}},{key:"valueReducer",value:function e(t){return{dependencies:Object.values(t).filter(function(e){return c.Type.isArrayFilled(e.list)})}}}]);return t}(t.ContentWrapper);e.default=X})(this.BX.Landing.Ui.Panel.Formsettingspanel.Content=this.BX.Landing.Ui.Panel.Formsettingspanel.Content||{},BX.Landing.UI.Panel,BX.Landing.UI.Card,BX.Landing.UI.Field,BX.Landing.UI.Form,BX.Landing.UI.Field,BX.Landing.UI.Component,BX.Main,BX.Landing,BX.Landing.UI.Field,BX.Event,BX,BX.Landing.UI.Component,BX.Landing.UI.Component,BX.Landing);
//# sourceMappingURL=fields-rules.bundle.map.js